<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    

    <title>Tasks and Futures | Regent</title>
    
    <meta name="author" content="Stanford University">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css" media="all">

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>
  <body>

    <header class="navbar navbar-static-top rg-nav" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".rg-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">Regent</a>
    </div>
    <nav class="collapse navbar-collapse rg-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        
          
            
            
            
            <li class="">
              <a href="/install">Install</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/tutorial">Tutorial</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/reference">Reference</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/resources">Resources</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/publications">Publications</a>
            </li>
            
          
        
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/StanfordLegion/legion/tree/master/language">GitHub</a></li>
        <li><a href="/about">About</a></li>
      </ul>
    </nav>
  </div>
</header>


    <div class="container with-img-responsive">
  <div class="row">
    <div class="col-md-12">

      
        <h1 class="page-header">
          
            Tasks and Futures

          
          
        </h1>
      

      <p>This example introduces task launches and futures in Regent with a naive (but parallel) implementation of the Fibonacci numbers. This is not the fastest way to compute Fibonacci numbers, but demonstrates the functional nature of Regent tasks. The complete code for this example follows at the bottom of the page and can also be found in the <a href="https://github.com/StanfordLegion/legion/tree/master/tutorial">GitHub repository</a>.</p>
<h2 id="tasks">Tasks</h2>
<p><em>Tasks</em> are the fundamental unit of execution in Regent. Tasks are like functions in traditional languages. In fact, tasks execute sequentially. This means you can read the body of task from top-to-bottom, just like a normal sequential language.</p>
<p><em>Parallelism</em> occurs only among child tasks. (The terms <em>child tasks</em> and <em>subtasks</em> simply refer to the set of tasks called by a given task.) Though the two calls to <code>fibonacci</code> below appear to execute in sequence, they will actually run in parallel with each other.</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span></code></pre>
</figure>
<p>Two tasks can execute in parallel only if they do not interfere. For the two calls above, this is trivial: the parameters to the tasks above are passed by-value, and there are no mutable global variables in Regent. Thus there is no way for them to modify state used in the other task (and thus no possibility of interference).</p>
<p>Regent does support mutable state, however. We’ll consider this (and how it results in potential interference) in later tutorials.</p>
<h2 id="futures">Futures</h2>
<p>The <code>fibonacci</code> task itself is declared to take two <code>int</code> arguments, and returns an <code>int</code>. (The return type can be inferred in general and is shown below for pedagogical purposes only.) The body of the task stores the results of the two recursive calls in variables <code>f1</code> and <code>f2</code> and returns the sum of their values.</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">task</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">:</span> <span class="kt">int</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">end</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">1</span> <span class="k">end</span>

  <span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span>
<span class="k">end</span></code></pre>
</figure>
<p>In order to maximize parallelism, it’s important to avoid blocking the execution of a task as it calls subtasks. Regent has a number of optimizations that help ensure this. For example, the <code>fibonacci</code> task above returns a <em>future</em>, rather than a direct value. This means that the execution continues past the line <code>var f1 = fibonacci(n - 1)</code> to the second <code>fibonacci</code> call, even though the result of the call may not be ready yet. The <code>+</code> operator is also lifted to operate on futures. Thus, the task only blocks at the final <code>return</code> statement, after all parallel operations have been issued.</p>
<p>It is important to note that futures are <em>not</em> an a part of the Regent programming model. They are purely an optimization, inserted automatically by the compiler where appropriate. However, there are a number of ways to defeat the optimization—for example, a call to a C function cannot be issued in parallel, and thus must block execution if one of the arguments is a future.</p>
<p>The main task calls <code>fibonacci</code> in a loop. In order to avoid blocking on the call to <code>c.printf</code>, the call is extracted into a task and called on the result of each <code>fibonacci</code> call.</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">task</span> <span class="nf">print_result</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">,</span> <span class="n">result</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span>
  <span class="n">c</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">"Fibonacci(%d) = %d\n"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">main</span><span class="p">()</span>
  <span class="kd">var</span> <span class="n">num_fibonacci</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_fibonacci</span> <span class="k">do</span>
    <span class="n">print_result</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</figure>
<h2 id="final-code">Final Code</h2>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">import</span> <span class="s2">"regent"</span>

<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">terralib</span><span class="p">.</span><span class="n">includec</span><span class="p">(</span><span class="s2">"stdio.h"</span><span class="p">)</span>

<span class="k">task</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">:</span> <span class="kt">int</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">end</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">1</span> <span class="k">end</span>

  <span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">print_result</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">,</span> <span class="n">result</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span>
  <span class="n">c</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">"Fibonacci(%d) = %d\n"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">main</span><span class="p">()</span>
  <span class="kd">var</span> <span class="n">num_fibonacci</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_fibonacci</span> <span class="k">do</span>
    <span class="n">print_result</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">regentlib</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">main</span><span class="p">)</span></code></pre>
</figure>

    </div>
  </div>
</div>


    <footer class="rg-footer" role="contentinfo">
  <div class="container">
    <p>&copy; 2022 Stanford University.</p>
    <p>Powered by <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://getbootstrap.com/">Bootstrap</a>.</p>

    <ul class="rg-footer-links muted">
      <li><a href="/">Home</a></li>
      <li>&middot;</li>
      
        
          <li><a href="/install">Install</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/tutorial">Tutorial</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/reference">Reference</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/resources">Resources</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/publications">Publications</a></li>
          <li>&middot;</li>
        
      
      <li><a href="https://github.com/StanfordLegion/legion/tree/master/language">GitHub</a></li>
      <li>&middot;</li>
      <li><a href="/about">About</a></li>
    </ul>
  </div>
</footer>


    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-71475406-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>
