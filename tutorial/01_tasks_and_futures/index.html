<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    

    <title>Tasks and Futures | Regent</title>
    
    <meta name="author" content="Stanford University">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css" media="all">

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>
  <body>

    <header class="navbar navbar-static-top rg-nav" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".rg-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">Regent</a>
    </div>
    <nav class="collapse navbar-collapse rg-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        
          
            
            
            
            <li class="">
              <a href="/install">Install</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/tutorial">Tutorial</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/reference">Reference</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/resources">Resources</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/publications">Publications</a>
            </li>
            
          
        
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/StanfordLegion/legion/tree/master/language">GitHub</a></li>
        <li><a href="/about">About</a></li>
      </ul>
    </nav>
  </div>
</header>


    <div class="container with-img-responsive">
  <div class="row">
    <div class="col-md-12">

      
        <h1 class="page-header">
          
            Tasks and Futures

          
          
        </h1>
      

      <p>This example introduces task launches and futures in Regent with a naive (but parallel) implementation of the Fibonacci numbers. This is not the fastest way to compute Fibonacci numbers, but demonstrates the basic properties of Regent tasks. The complete code for this example follows at the bottom of the page and can also be found in the <a href="https://github.com/StanfordLegion/legion/tree/master/tutorial">GitHub repository</a>.</p>
<h2 id="tasks">Tasks</h2>
<p><em>Tasks</em> are the basic unit of execution in Regent, like functions in traditional languages. In fact, the bodies of tasks literally execute sequentially. This means you can read the code for a task from top to bottom, as in a conventional programming language.</p>
<p>In Regent, when a task calls other tasks (called <em>child tasks</em> or <em>subtasks</em>), those tasks may execute in parallel. However, Regent always ensures that the program as a whole behaves as if it were executing sequentially. Thus, when reading a program to understand what it does, it is sufficient to imagine that the tasks are simply running in order, one after another.</p>
<p>Behind the scenes, Regent analyzes the sequence of task calls to determine what is safe to execute in parallel. In the example below, the two calls to <code>fibonacci</code> below run in parallel because they do not <em>interfere</em> (i.e., there is no way for one task to influence the result of the other).</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span></code></pre>
</figure>
<p>For the <code>fibonacci</code> tasks above, checking for interference is trivial: the parameters to the tasks are passed by-value, and Regent programs never contain mutable global variables. Thus there is no way for either task to modify state used in the other task (and thus no possibility of interference).</p>
<p>Regent does support mutable state, however. We’ll consider this (and how it results in potential interference) in later tutorials.</p>
<h2 id="futures">Futures</h2>
<p>The <code>fibonacci</code> task takes one <code>int</code> argument, and returns an <code>int</code>. (The return type can be inferred in general and is shown below for pedagogical purposes only.) The body of the task stores the results of the two recursive calls in variables <code>f1</code> and <code>f2</code> and returns the sum of their values.</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">task</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">:</span> <span class="kt">int</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">end</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">1</span> <span class="k">end</span>

  <span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span>
<span class="k">end</span></code></pre>
</figure>
<p>As noted above, the body of a Regent task literally executes sequentially. In the example above, that means the first call (to <code>fibonacci(n - 1)</code>) will be considered prior to the second call (<code>fibonacci(n - 2)</code>). Each task call is issued asynchronously. That is, execution proceeds in parallel to the parent task (assuming Regent can determine that this is safe to do). This is important, because if the parent blocks prior to the second call, Regent is unable to analyze it for parallelism.</p>
<p>An example of something that might block execution would be calling into a C function with the value of <code>f1</code>:</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">regentlib</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">"value of first fibonnaci is %d\n"</span><span class="p">,</span> <span class="n">f1</span><span class="p">)</span> <span class="c1">-- blocks!</span>
<span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span></code></pre>
</figure>
<p>The second line in this snippet blocks, because it calls a C function (<code>printf</code>). In general, Regent has no ability to analyze the contents or effects of C functions, and such functions (if passed values resulting from tasks) may inhibit parallelism. An easy way to work around this is to wrap the call to <code>printf</code> in a task. This way, Regent can analyze the task for parallelism, as it does with the rest of the program.</p>
<p>Behind the scenes, Regent maximizes parallelism by making each task return a <em>future</em>. Futures represent the results of tasks yet to be completed. In most cases, users don’t need to be concerned with futures: as noted above, as long as the program avoids passing any futures into C functions, Regent will handle the parallelism automatically. Tasks accept futures directly, so passing a future to a task does not block. Operators like <code>+</code> can also be optimized by Regent to work on futures, so they do not block either. Similarly, Regent can optimize most conditional statements (such as <code>if</code> and <code>while</code>) that are predicated on futures, as long as those conditionals do not control the execution of C functions. The few remaining statements that block on futures (e.g., <code>return</code>) are usually not a problem for parallelism.</p>
<p>Returning to our original example, <code>main</code> calls <code>fibonacci</code> in a loop. In order to avoid blocking on the call to the C function <code>c.printf</code>, the call is extracted into a task and called on the result of each <code>fibonacci</code> call. Thus the entire body of <code>main</code> will execute in parallel, with each <code>print_result</code> waiting on its corresponding <code>fibonnaci</code>, but not otherwise blocking the execution of other <code>fibonnaci</code> or <code>print_result</code> calls.</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">task</span> <span class="nf">print_result</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">,</span> <span class="n">result</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span>
  <span class="n">c</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">"Fibonacci(%d) = %d\n"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">main</span><span class="p">()</span>
  <span class="kd">var</span> <span class="n">num_fibonacci</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_fibonacci</span> <span class="k">do</span>
    <span class="n">print_result</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span></code></pre>
</figure>
<h2 id="final-code">Final Code</h2>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">import</span> <span class="s2">"regent"</span>

<span class="k">task</span> <span class="nf">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span> <span class="p">:</span> <span class="kt">int</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">0</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">0</span> <span class="k">end</span>
  <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="mi">1</span> <span class="k">then</span> <span class="k">return</span> <span class="mi">1</span> <span class="k">end</span>

  <span class="kd">var</span> <span class="n">f1</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">f2</span> <span class="o">=</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">n</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span>

  <span class="k">return</span> <span class="n">f1</span> <span class="o">+</span> <span class="n">f2</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">print_result</span><span class="p">(</span><span class="n">n</span> <span class="p">:</span> <span class="kt">int</span><span class="p">,</span> <span class="n">result</span> <span class="p">:</span> <span class="kt">int</span><span class="p">)</span>
  <span class="n">regentlib</span><span class="p">.</span><span class="n">c</span><span class="p">.</span><span class="n">printf</span><span class="p">(</span><span class="s2">"Fibonacci(%d) = %d\n"</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="n">result</span><span class="p">)</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">main</span><span class="p">()</span>
  <span class="kd">var</span> <span class="n">num_fibonacci</span> <span class="o">=</span> <span class="mi">7</span>
  <span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">num_fibonacci</span> <span class="k">do</span>
    <span class="n">print_result</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">fibonacci</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">regentlib</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">main</span><span class="p">)</span></code></pre>
</figure>

    </div>
  </div>
</div>


    <footer class="rg-footer" role="contentinfo">
  <div class="container">
    <p>&copy; 2022 Stanford University.</p>
    <p>Powered by <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://getbootstrap.com/">Bootstrap</a>.</p>

    <ul class="rg-footer-links muted">
      <li><a href="/">Home</a></li>
      <li>&middot;</li>
      
        
          <li><a href="/install">Install</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/tutorial">Tutorial</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/reference">Reference</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/resources">Resources</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/publications">Publications</a></li>
          <li>&middot;</li>
        
      
      <li><a href="https://github.com/StanfordLegion/legion/tree/master/language">GitHub</a></li>
      <li>&middot;</li>
      <li><a href="/about">About</a></li>
    </ul>
  </div>
</footer>


    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-71475406-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>
