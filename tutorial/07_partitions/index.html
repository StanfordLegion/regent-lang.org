<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    

    <title>Partitions | Regent</title>
    
    <meta name="author" content="Stanford University">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link href="/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="/css/style.css" rel="stylesheet" type="text/css" media="all">
    <link href="/css/syntax.css" rel="stylesheet" type="text/css" media="all">

    <!-- Fav and touch icons -->
    <!-- Update these with your own images
      <link rel="shortcut icon" href="images/favicon.ico">
      <link rel="apple-touch-icon" href="images/apple-touch-icon.png">
      <link rel="apple-touch-icon" sizes="72x72" href="images/apple-touch-icon-72x72.png">
      <link rel="apple-touch-icon" sizes="114x114" href="images/apple-touch-icon-114x114.png">
    -->
  </head>
  <body>

    <header class="navbar navbar-static-top rg-nav" id="top" role="banner">
  <div class="container">
    <div class="navbar-header">
      <button class="navbar-toggle collapsed" type="button" data-toggle="collapse" data-target=".rg-navbar-collapse">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a href="/" class="navbar-brand">Regent</a>
    </div>
    <nav class="collapse navbar-collapse rg-navbar-collapse" role="navigation">
      <ul class="nav navbar-nav">
        
          
            
            
            
            <li class="">
              <a href="/install">Install</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/tutorial">Tutorial</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/reference">Reference</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/resources">Resources</a>
            </li>
            
          
        
          
            
            
            
            <li class="">
              <a href="/publications">Publications</a>
            </li>
            
          
        
      </ul>

      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://github.com/StanfordLegion/legion/tree/master/language">GitHub</a></li>
        <li><a href="/about">About</a></li>
      </ul>
    </nav>
  </div>
</header>


    <div class="container with-img-responsive">
  <div class="row">
    <div class="col-md-12">

      
        <h1 class="page-header">
          
            Partitions

          
          
        </h1>
      

      <p>In theory, tasks and regions are enough to induce a parallel execution. If you create <code>N</code> regions, and <code>N</code> tasks, those will all be able to run in parallel. But it’s a lot more pleasant—and more efficient too—to use data partitioning. Partitioning also opens the door to much more powerful tools down the road, like using multiple partitions to implement ghost cell exchanges.</p>
<p>For now, we’re going to look at what can be achieved with a single partition of the data.</p>
<h2 id="partitions">Partitions</h2>
<p><em>Partitions</em> divide regions into a number of subregions. There are many partitioning operators, but the most basic is <code>equal</code>. The <code>equal</code> operator creates a specified number of roughly equal-sized subregions. (The subregions are only <em>roughly</em> equal-sized because the number of subregions created may not evenly divide the region being divided.)</p>
<p>The following code divides <code>r</code> into <code>N</code> subregions:</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="kd">var</span> <span class="n">p</span> <span class="o">=</span> <span class="kt">partition</span><span class="p">(</span><span class="k">equal</span><span class="p">,</span> <span class="n">r</span><span class="p">,</span> <span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">,</span> <span class="n">N</span><span class="p">))</span></code></pre>
</figure>
<p>Having partitioned <code>r</code> as <code>p</code>, we can then access the <code>i</code>th subregion as <code>p[i]</code>. This enables us to write, for example, a loop of tasks over the subregions of a partition.</p>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">for</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span> <span class="n">N</span> <span class="k">do</span>
  <span class="n">some_task</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">end</span></code></pre>
</figure>
<p>The <code>equal</code> operator is always guarranteed to produce subregions that satisfy certain relationships. In particular:</p>
<ul>
<li><p>The subregions <code>p[i]</code> and <code>p[j]</code> are guarranteed to be <em>disjoint</em> (that is, they do not contain any common elements), for all <code>i !=     j</code>.</p></li>
<li><p>The subregions of <code>p</code>, taken as a whole, are guarranteed to be <em>complete</em>. That is, the union of <code>p[i]</code> for all <code>i</code> is equal to the original parent region.</p></li>
</ul>
<p>These properties are <em>not</em> guarranted to hold for all possible partitions. There are partitions in Regent that are <em>aliased</em> (<code>p[i]</code> overlaps <code>p[j]</code> for some <code>i != j</code>), and ones that are <em>incomplete</em> (the union of subregions does not cover the parent region). In fact, these are some of the most interesting and useful partitions. But for now, we’ll stick with the <code>equal</code> operator and its disjoint and complete partitions.</p>
<h2 id="subregions-are-views">Subregions are Views</h2>
<h2 id="partitioning-operators">Partitioning Operators</h2>
<h2 id="passing-partitions-to-tasks">Passing Partitions to Tasks</h2>
<h2 id="daxpy-with-partitions">DAXPY with Partitions</h2>
<h2 id="final-code">Final Code</h2>
<figure class="highlight">
<pre><code class="language-regent" data-lang="regent"><span class="k">import</span> <span class="s2">"regent"</span>

<span class="kd">local</span> <span class="n">c</span> <span class="o">=</span> <span class="n">regentlib</span><span class="p">.</span><span class="n">c</span>

<span class="k">fspace</span> <span class="nf">input</span> <span class="p">{</span>
  <span class="n">x</span> <span class="p">:</span> <span class="kt">double</span><span class="p">,</span>
  <span class="n">y</span> <span class="p">:</span> <span class="kt">double</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">fspace</span> <span class="nf">output</span> <span class="p">{</span>
  <span class="n">z</span> <span class="p">:</span> <span class="kt">double</span><span class="p">,</span>
<span class="p">}</span>

<span class="k">task</span> <span class="nf">init</span><span class="p">(</span><span class="n">input_lr</span> <span class="p">:</span> <span class="kt">region</span><span class="p">(</span><span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">),</span> <span class="n">input</span><span class="p">))</span>
<span class="k">where</span> <span class="k">writes</span><span class="p">(</span><span class="n">input_lr</span><span class="p">.{</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">})</span> <span class="k">do</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">input_lr</span> <span class="k">do</span>
    <span class="n">input_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">drand48</span><span class="p">()</span>
    <span class="n">input_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">drand48</span><span class="p">()</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">daxpy</span><span class="p">(</span><span class="n">input_lr</span> <span class="p">:</span> <span class="kt">region</span><span class="p">(</span><span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">),</span> <span class="n">input</span><span class="p">),</span>
           <span class="n">output_lr</span> <span class="p">:</span> <span class="kt">region</span><span class="p">(</span><span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">),</span> <span class="n">output</span><span class="p">),</span>
           <span class="n">alpha</span> <span class="p">:</span> <span class="kt">double</span><span class="p">)</span>
<span class="k">where</span> <span class="k">writes</span><span class="p">(</span><span class="n">output_lr</span><span class="p">.</span><span class="n">z</span><span class="p">),</span> <span class="k">reads</span><span class="p">(</span><span class="n">input_lr</span><span class="p">.{</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">})</span> <span class="k">do</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">input_lr</span> <span class="k">do</span>
    <span class="n">output_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">input_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">+</span> <span class="n">input_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">check</span><span class="p">(</span><span class="n">input_lr</span> <span class="p">:</span> <span class="kt">region</span><span class="p">(</span><span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">),</span> <span class="n">input</span><span class="p">),</span>
           <span class="n">output_lr</span> <span class="p">:</span> <span class="kt">region</span><span class="p">(</span><span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">),</span> <span class="n">output</span><span class="p">),</span>
           <span class="n">alpha</span> <span class="p">:</span> <span class="kt">double</span><span class="p">)</span>
<span class="k">where</span> <span class="k">reads</span><span class="p">(</span><span class="n">input_lr</span><span class="p">,</span> <span class="n">output_lr</span><span class="p">)</span> <span class="k">do</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">input_lr</span> <span class="k">do</span>
    <span class="kd">var</span> <span class="n">expected</span> <span class="o">=</span> <span class="n">alpha</span><span class="o">*</span><span class="n">input_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">x</span> <span class="o">+</span> <span class="n">input_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">y</span>
    <span class="kd">var</span> <span class="n">received</span> <span class="o">=</span> <span class="n">output_lr</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">z</span>
    <span class="n">regentlib</span><span class="p">.</span><span class="n">assert</span><span class="p">(</span><span class="n">expected</span> <span class="o">==</span> <span class="n">received</span><span class="p">,</span> <span class="s2">"check failed"</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">task</span> <span class="nf">main</span><span class="p">()</span>
  <span class="kd">var</span> <span class="n">num_elements</span> <span class="o">=</span> <span class="mi">1024</span>
  <span class="kd">var</span> <span class="n">is</span> <span class="o">=</span> <span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">,</span> <span class="n">num_elements</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">input_lr</span> <span class="o">=</span> <span class="kt">region</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">input</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">output_lr</span> <span class="o">=</span> <span class="kt">region</span><span class="p">(</span><span class="n">is</span><span class="p">,</span> <span class="n">output</span><span class="p">)</span>

  <span class="kd">var</span> <span class="n">num_subregions</span> <span class="o">=</span> <span class="mi">4</span>
  <span class="kd">var</span> <span class="n">ps</span> <span class="o">=</span> <span class="kt">ispace</span><span class="p">(</span><span class="kt">int1d</span><span class="p">,</span> <span class="n">num_subregions</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">input_lp</span> <span class="o">=</span> <span class="kt">partition</span><span class="p">(</span><span class="k">equal</span><span class="p">,</span> <span class="n">input_lr</span><span class="p">,</span> <span class="n">ps</span><span class="p">)</span>
  <span class="kd">var</span> <span class="n">output_lp</span> <span class="o">=</span> <span class="kt">partition</span><span class="p">(</span><span class="k">equal</span><span class="p">,</span> <span class="n">output_lr</span><span class="p">,</span> <span class="n">ps</span><span class="p">)</span>

  <span class="k">__demand</span><span class="p">(</span><span class="k">__index_launch</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">ps</span> <span class="k">do</span>
    <span class="n">init</span><span class="p">(</span><span class="n">input_lp</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
  <span class="k">end</span>

  <span class="kd">var</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">c</span><span class="p">.</span><span class="n">drand48</span><span class="p">()</span>
  <span class="k">__demand</span><span class="p">(</span><span class="k">__index_launch</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">ps</span> <span class="k">do</span>
    <span class="n">daxpy</span><span class="p">(</span><span class="n">input_lp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output_lp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">__demand</span><span class="p">(</span><span class="k">__index_launch</span><span class="p">)</span>
  <span class="k">for</span> <span class="n">i</span> <span class="k">in</span> <span class="n">ps</span> <span class="k">do</span>
    <span class="n">check</span><span class="p">(</span><span class="n">input_lp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">output_lp</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">alpha</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
<span class="n">regentlib</span><span class="p">.</span><span class="n">start</span><span class="p">(</span><span class="n">main</span><span class="p">)</span></code></pre>
</figure>

    </div>
  </div>
</div>


    <footer class="rg-footer" role="contentinfo">
  <div class="container">
    <p>&copy; 2022 Stanford University.</p>
    <p>Powered by <a href="http://jekyllrb.com/">Jekyll</a> and <a href="http://getbootstrap.com/">Bootstrap</a>.</p>

    <ul class="rg-footer-links muted">
      <li><a href="/">Home</a></li>
      <li>&middot;</li>
      
        
          <li><a href="/install">Install</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/tutorial">Tutorial</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/reference">Reference</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/resources">Resources</a></li>
          <li>&middot;</li>
        
      
        
          <li><a href="/publications">Publications</a></li>
          <li>&middot;</li>
        
      
      <li><a href="https://github.com/StanfordLegion/legion/tree/master/language">GitHub</a></li>
      <li>&middot;</li>
      <li><a href="/about">About</a></li>
    </ul>
  </div>
</footer>


    <!-- Placed at the end of the document so the pages load faster -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>

    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-71475406-1', 'auto');
      ga('send', 'pageview');

    </script>
  </body>
</html>
